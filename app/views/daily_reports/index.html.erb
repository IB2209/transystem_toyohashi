<div class="tmp_home">
  <div class="daily_per">
    <h2>2025å¹´</h2>
    <h1 style="margin-bottom: 70px;">COXGEARè±Šæ©‹å–¶æ¥­æ‰€</h1>


    <!-- æœˆã”ã¨ã®ã‚¿ãƒ– -->
    <ul class="month-tab-header">
  <% @daily_reports_by_month.keys.each_with_index do |month, index| %>
    <li class="month-tab-link <%= 'active' if index.zero? %>" data-month="month-<%= month.strftime('%Y-%m') %>">
      <%= month.strftime('%-mæœˆ') %>
    </li>
  <% end %>
</ul>

<% @daily_reports_by_month.each do |month, reports_by_person| %>
  <div class="month-tab-pane <%= 'active' if @daily_reports_by_month.keys.first == month %>" id="month-<%= month.strftime('%Y-%m') %>">


    <!-- ğŸ“Œ å…¨æ‹…å½“è€…ã®åˆè¨ˆã‚’è¡¨ç¤ºã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <h2><%= month.strftime("%-mæœˆ") %> è±Šæ©‹å–¶æ¥­æ‰€</h2>
    <table class="summary-table">
      <thead>
        <tr>
          <th></th>
          <th>çµŒè²»åˆè¨ˆ</th>
          <th>ç‡ƒæ–™ä»£ï¼ˆâ„“ï¼‰</th>
          <th>é«˜é€Ÿä»£</th>
          <th>äº¤é€šä»£</th>
          <th>å®¿æ³Šä»£</th>
          <th>è‡ªèµ°å°æ•°</th>
          <th>è‡ªèµ°è·é›¢</th>
          <th>ã„ã™ã‚</th>
          <th>UD</th>
          <th>FUSO</th>
          <th>ZERO</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>è±Šæ©‹å–¶æ¥­æ‰€</th>
          <td>
            <% total_expense_all = reports_by_person.values.flatten.sum { |r| 
              r.movement_records.sum(:fuel_fee).to_i +
              r.movement_records.sum(:toll_fee).to_i +
              r.movement_records.sum(:transportation_fee).to_i +
              r.movement_records.sum(:lodging_fee).to_i
            } %>
            <%= number_with_delimiter(total_expense_all) + "å††" if total_expense_all > 0 %>
          </td>

          <td>
            <% fuel_fee_all = reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:fuel_fee).to_i } %>
            <% fuel_amount_all = reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:fuel_amount).to_i } %>
            <%= number_with_delimiter(fuel_fee_all) + "å††" if fuel_fee_all > 0 %>
            <% if fuel_amount_all > 0 %>
              (<%= number_with_delimiter(fuel_amount_all) %>â„“)
            <% end %>
          </td>

          <td><%= number_with_delimiter(reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:toll_fee).to_i }) + "å††" if reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:toll_fee).to_i } > 0 %></td>
          <td><%= number_with_delimiter(reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:transportation_fee).to_i }) + "å††" if reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:transportation_fee).to_i } > 0 %></td>
          <td><%= number_with_delimiter(reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:lodging_fee).to_i }) + "å††" if reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:lodging_fee).to_i } > 0 %></td>

          <td>
            <% movement_count_all = reports_by_person.values.flatten.sum { |r| r.movement_records.count } %>
            <%= number_with_delimiter(movement_count_all) if movement_count_all > 0 %>
          </td>

          <td>
            <% total_travel_distance_all = reports_by_person.values.flatten.sum { |r| r.movement_records.sum(:travel_distance).to_i } %>
            <%= number_with_delimiter(total_travel_distance_all) + "km" if total_travel_distance_all > 0 %>
          </td>

          <td>
            <% isuzu_count_all = reports_by_person.values.flatten.sum { |r| r.movement_records.where(request_type: 'ã„ã™ã‚').count } %>
            <%= number_with_delimiter(isuzu_count_all) if isuzu_count_all > 0 %>
          </td>

          <td>
            <% ud_count_all = reports_by_person.values.flatten.sum { |r| r.movement_records.where(request_type: 'UD').count } %>
            <%= number_with_delimiter(ud_count_all) if ud_count_all > 0 %>
          </td>

          <td>
            <% fuso_count_all = reports_by_person.values.flatten.sum { |r| r.movement_records.where(request_type: 'FUSO').count } %>
            <%= number_with_delimiter(fuso_count_all) if fuso_count_all > 0 %>
          </td>

          <td>
            <% zero_count_all = reports_by_person.values.flatten.sum { |r| r.movement_records.where(request_type: 'ZERO').count } %>
            <%= number_with_delimiter(zero_count_all) if zero_count_all > 0 %>
          </td>
          
        </tr>
        
      </tbody>
    </table>



        <!-- ğŸ“Œ æœˆé–“é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ« -->
        <h2 style="margin-top:50px;"><%= month.strftime("%-mæœˆ") %> å„æ‹…å½“</h2>
        <table class="summary-table">
  <thead>
    <tr>
      <th></th>
      <th>å‡ºå‹¤æ—¥æ•°<br>(æ®‹æ¥­æ™‚é–“)</th>
      <th>çµŒè²»åˆè¨ˆ</th>
      <th>ç‡ƒæ–™ä»£ï¼ˆâ„“ï¼‰</th>
      <th>é«˜é€Ÿä»£</th>
      <th>äº¤é€šä»£</th>
      <th>å®¿æ³Šä»£</th>
      <th>è‡ªèµ°å°æ•°</th>
      <th>è‡ªèµ°è·é›¢</th>
      <th>ã„ã™ã‚</th>
      <th>UD</th>
      <th>FUSO</th>
      <th>ZERO</th>
    </tr>
  </thead>
  <tbody>
  <% DailyReport::RESPONSIBLE_PEOPLE.each do |person| %>
    <% reports = reports_by_person[person] || [] %>

    <% total_overtime_minutes = reports.sum do |r| 
      next 0 unless r.start_time.present? && r.end_time.present?
      work_duration = ((r.end_time - r.start_time) / 60).to_i # å‹¤å‹™æ™‚é–“ï¼ˆåˆ†å˜ä½ï¼‰
      overtime_minutes = [work_duration - 540, 0].max # 9æ™‚é–“(540åˆ†)è¶…ãˆãŸåˆ†ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      overtime_minutes
    end %>

    <tr>
      <th><%= person %></th>

      <td>
        <%= reports.map(&:move_date).uniq.count %>æ—¥
        <% if total_overtime_minutes > 0 %>
          (<%= total_overtime_minutes / 60 %>h)
        <% end %>
      </td>

      <!-- âœ… çµŒè²»åˆè¨ˆï¼ˆ0ã®å ´åˆã¯ç©ºç™½ï¼‰ -->
      <td>
        <% total_expense = reports.sum { |r| 
          r.movement_records.sum(:fuel_fee).to_i +
          r.movement_records.sum(:toll_fee).to_i +
          r.movement_records.sum(:transportation_fee).to_i +
          r.movement_records.sum(:lodging_fee).to_i
        } %>
        <%= number_with_delimiter(total_expense) + "å††" if total_expense > 0 %>
      </td>

      <!-- âœ… ç‡ƒæ–™ä»£ + ç‡ƒæ–™é‡ï¼ˆ0ã®å ´åˆã¯ç©ºç™½ï¼‰ -->
      <td>
        <% fuel_fee = reports.sum { |r| r.movement_records.sum(:fuel_fee).to_i } %>
        <% fuel_amount = reports.sum { |r| r.movement_records.sum(:fuel_amount).to_i } %>
        <%= number_with_delimiter(fuel_fee) + "å††" if fuel_fee > 0 %>
        <% if fuel_amount > 0 %>
          (<%= number_with_delimiter(fuel_amount) %>â„“)
        <% end %>
      </td>

      <!-- âœ… é«˜é€Ÿä»£ã€äº¤é€šä»£ã€å®¿æ³Šä»£ï¼ˆ0ã®å ´åˆã¯ç©ºç™½ï¼‰ -->
      <td><%= number_with_delimiter(reports.sum { |r| r.movement_records.sum(:toll_fee).to_i }) + "å††" if reports.sum { |r| r.movement_records.sum(:toll_fee).to_i } > 0 %></td>
      <td><%= number_with_delimiter(reports.sum { |r| r.movement_records.sum(:transportation_fee).to_i }) + "å††" if reports.sum { |r| r.movement_records.sum(:transportation_fee).to_i } > 0 %></td>
      <td><%= number_with_delimiter(reports.sum { |r| r.movement_records.sum(:lodging_fee).to_i }) + "å††" if reports.sum { |r| r.movement_records.sum(:lodging_fee).to_i } > 0 %></td>

      <!-- âœ… ç§»å‹•å°æ•°ï¼ˆç§»å‹•è¨˜éŒ²ãŒãªã„å ´åˆã¯0è¡¨ç¤ºï¼‰ -->
      <td>
        <% movement_count = reports.sum { |r| r.movement_records.count } %>
        <%= number_with_delimiter(movement_count) if movement_count > 0 %>
      </td>

      <!-- âœ… ç·ç§»å‹•è·é›¢ï¼ˆ0ã®å ´åˆã¯ç©ºç™½ï¼‰ -->
      <td>
        <% total_travel_distance = reports.sum { |r| r.movement_records.sum(:travel_distance).to_i } %>
        <%= number_with_delimiter(total_travel_distance) + "km" if total_travel_distance > 0 %>
      </td>

      <!-- âœ… å„ãƒ¡ãƒ¼ã‚«ãƒ¼ã®ç§»å‹•å°æ•°ï¼ˆ0ã®å ´åˆã¯ç©ºç™½ï¼‰ -->
        <td>
  <% isuzu_count = reports_by_person[person]&.sum { |r| r.movement_records.where(request_type: 'ã„ã™ã‚').count } || 0 %>
  <%= number_with_delimiter(isuzu_count) if isuzu_count > 0 %>
</td>

<td>
  <% ud_count = reports_by_person[person]&.sum { |r| r.movement_records.where(request_type: 'UD').count } || 0 %>
  <%= number_with_delimiter(ud_count) if ud_count > 0 %>
</td>

<td>
  <% fuso_count = reports_by_person[person]&.sum { |r| r.movement_records.where(request_type: 'FUSO').count } || 0 %>
  <%= number_with_delimiter(fuso_count) if fuso_count > 0 %>
</td>

<td>
  <% zero_count = reports_by_person[person]&.sum { |r| r.movement_records.where(request_type: 'ZERO').count } || 0 %>
  <%= number_with_delimiter(zero_count) if zero_count > 0 %>
</td>

    </tr>
  <% end %>
</tbody>

</table>

<hr style="margin: 50px auto; border-color: white;">


        
        <!-- ã‚¿ãƒ–ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ‹…å½“è€…ã”ã¨ï¼‰ -->
        <ul class="tab-header">
  <% fixed_order = ["è¥¿æ‘", "åœŸå±‹", "çŸ³å·", "å°ç¬ åŸ", "å¤§åŸ", "æ´¥ç”°", "å¤ªæˆ‘", "èˆœå¹³", "ç«¹æœ¬", "å°é‡ç”°", "è—¤ç”°"] %>
  <% reports_by_person.keys.sort_by { |person| fixed_order.index(person) || fixed_order.size }.each_with_index do |person, index| %>
    <li class="tab-link <%= 'active' if index.zero? %>" data-tab="tab-<%= month.strftime('%Y-%m') %>-<%= person %>">
      <%= person %>
    </li>
  <% end %>
</ul>


        <!-- ã‚¿ãƒ–ã®å†…å®¹ -->
        <div class="tab-content new_per">
          <% reports_by_person.each do |person, reports| %>
            <div class="tab-pane <%= 'active' if reports_by_person.keys.first == person %>" id="tab-<%= month.strftime('%Y-%m') %>-<%= person %>">
              <h2><%= person %> ã®æ—¥å ±</h2>

              <table class="report-table">
                <thead>
                  <tr>
                    <th>æ—¥ä»˜</th>
                    <th>å‡ºç¤¾ - é€€ç¤¾(æ®‹æ¥­)</th>
                    <th>æ¥­å‹™å†…å®¹</th>
                    <th>ä¾é ¼</th>
                    <th>å‹å¼</th>
                    <th>è»Šä½“ç•ªå·</th>
                    <th>å¼•å–å…ˆ</th>
                    <th>ç´è»Šå…ˆ</th>
                    <th>ç·è·é›¢</th>
                    <th>ç‡ƒæ–™ä»£</th>
                    <th>é«˜é€Ÿä»£</th>
                    <th>äº¤é€šä»£</th>
                    <th>å®¿æ³Šä»£</th>
                    <th>çµŒè²»åˆè¨ˆ</th>
                    <th>å‚™è€ƒ</th>
                    <th>è©³ç´°</th>
                  </tr>
                </thead>
                  <tbody>
  <% reports.group_by(&:move_date).each do |date, grouped_reports| %>
    <% first_report = grouped_reports.first %>
    <% movement_records = first_report.movement_records %>

    <% if movement_records.present? %>
      <% movement_records.each_with_index do |record, record_index| %>
        <tr>
          <% if record_index == 0 %>
            <td rowspan="<%= movement_records.size %>">
              <%= link_to l(date, format: "%-dæ—¥(%a)"), daily_report_path(first_report), class: "" %>
            </td>

            <!-- âœ… å‡ºç¤¾ - é€€ç¤¾ï¼ˆæ®‹æ¥­æ™‚é–“ï¼‰ -->
            <td rowspan="<%= movement_records.size %>">
              <%= first_report.start_time.strftime("%-H:%M") if first_report.start_time.present? %> -
              <%= first_report.end_time.strftime("%-H:%M") if first_report.end_time.present? %>

              <% if first_report.start_time.present? && first_report.end_time.present? %>
                <% work_duration = ((first_report.end_time - first_report.start_time) / 60).to_i %>
                <% overtime_minutes = [work_duration - 540, 0].max %>
                <% if overtime_minutes > 0 %>
                  (<%= overtime_minutes / 60 %>:<%= overtime_minutes % 60 %>)
                <% end %>
              <% end %>
            </td>
            <td rowspan="<%= movement_records.size %>"><%= first_report.work_content %></td>
          <% end %>

          <td><%= record.request_type %></td>
          <td><%= record.model || "" %></td>
          <td><%= record.chassis_number || "" %></td>
          <td><%= record.pickup_location || "" %></td>
          <td><%= record.delivery_location || "" %></td>
          <td>
            <%= if record.departure_distance.present? && record.arrival_distance.present?
                  "#{number_with_delimiter(record.arrival_distance - record.departure_distance)} km"
                else
                  "æœªè¨­å®š"
                end
            %>
          </td>
          <td>
            <% if record.fuel_fee.to_i > 0 %>
              <%= number_with_delimiter(record.fuel_fee) %>å††
            <% end %>
            <% if record.fuel_amount.present? && record.fuel_amount > 0 %>
              (<%= record.fuel_amount.to_s.sub(/\.0+$/, '') %>â„“)
            <% end %>
          </td>
          <td><%= record.toll_fee.to_i > 0 ? "#{number_with_delimiter(record.toll_fee)}å††" : "" %></td>
          <td><%= record.transportation_fee.to_i > 0 ? "#{number_with_delimiter(record.transportation_fee)}å††" : "" %></td>
          <td><%= record.lodging_fee.to_i > 0 ? "#{number_with_delimiter(record.lodging_fee)}å††" : "" %></td>

          <% total_fee = record.toll_fee.to_i + record.fuel_fee.to_i + record.transportation_fee.to_i + record.lodging_fee.to_i %>
          <td><%= total_fee > 0 ? "#{number_with_delimiter(total_fee)}å††" : "" %></td>

          <% if record_index == 0 %>
            <td rowspan="<%= movement_records.size %>"><%= first_report.remarks.presence || "" %></td>
            <td rowspan="<%= movement_records.size %>">
              <%= link_to "è©³ç´°", daily_report_path(first_report), class: "edit-link" %> 
            </td>
          <% end %>
        </tr>
      <% end %>
    <% else %>
      <!-- âœ… æ¬ å‹¤ãƒ‡ãƒ¼ã‚¿ã‚‚è¡¨ç¤º -->
<tr>
  <td><%= link_to l(date, format: "%-dæ—¥(%a)"), daily_report_path(first_report), class: "" %></td>

  <!-- âœ… å‡ºç¤¾ - é€€ç¤¾ï¼ˆæ®‹æ¥­æ™‚é–“ï¼‰ -->
  <td>
    <% if first_report.attendance_status == "å‡ºå‹¤" && first_report.start_time.present? && first_report.end_time.present? %>
      <%= first_report.start_time.strftime("%-H:%M") %> - <%= first_report.end_time.strftime("%-H:%M") %>

      <% work_duration = ((first_report.end_time - first_report.start_time) / 60).to_i %>
      <% overtime_minutes = [work_duration - 540, 0].max %>
      <% if overtime_minutes > 0 %>
        (<%= overtime_minutes / 60 %>h)
      <% end %>
    <% end %>
  </td>
        <td><%= first_report.attendance_status == "å‡ºå‹¤" ? first_report.work_content : "" %></td>
        <td colspan="5"></td>
        <td></td> <!-- ç·è·é›¢ -->
        <td></td> <!-- ç‡ƒæ–™ä»£ -->
        <td></td> <!-- é«˜é€Ÿä»£ -->
        <td></td> <!-- äº¤é€šä»£ -->
        <td></td> <!-- å®¿æ³Šä»£ -->
        <td></td> <!-- çµŒè²»åˆè¨ˆ -->
        <td><%= first_report.attendance_status == "æ¬ å‹¤" ? "æ¬ å‹¤ç†ç”±: #{first_report.absence_reason}" : first_report.remarks.presence || "" %></td>
        <td><%= link_to "è©³ç´°", daily_report_path(first_report), class: "edit-link" %></td>
      </tr>
    <% end %>
  <% end %>
</tbody>


              </table>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let monthTabs = document.querySelectorAll(".month-tab-link");
    let monthContents = document.querySelectorAll(".month-tab-pane");

    let personTabs = document.querySelectorAll(".tab-link");
    let personContents = document.querySelectorAll(".tab-pane");

    monthTabs.forEach(tab => {
      tab.addEventListener("click", function () {
        let target = this.getAttribute("data-month");

        monthTabs.forEach(t => t.classList.remove("active"));
        this.classList.add("active");

        monthContents.forEach(tc => tc.classList.remove("active"));
        document.getElementById(target).classList.add("active");
      });
    });

    personTabs.forEach(tab => {
      tab.addEventListener("click", function () {
        let target = this.getAttribute("data-tab");

        personTabs.forEach(t => t.classList.remove("active"));
        this.classList.add("active");

        personContents.forEach(tc => tc.classList.remove("active"));
        document.getElementById(target).classList.add("active");
      });
    });
  });
</script>

<style>
  .month-tab-header {
    display: flex;
    list-style: none;
    padding: 0;
    border-bottom: 2px solid #ccc;
    margin-bottom: 10px;
  }
  .month-tab-header li {
    padding: 10px 15px;
    cursor: pointer;
    border: 1px solid #ccc;
    margin-right: 5px;
    background: #f4f4f4;
  }
  .month-tab-header li.active {
    background: #ddd;
    font-weight: bold;
  }
  /* ğŸ“Œ æœˆã”ã¨ã®ã‚¿ãƒ– */
.month-tab-header {
  display: flex;
  list-style: none;
  padding: 0;
  border-bottom: 2px solid #ccc;
  margin-bottom: 10px;
  justify-content: center;
}

.month-tab-header li {
  padding: 10px 12px;
  cursor: pointer;
  border: 1px solid #ccc;
  margin: 0 5px;
  background: #f8f8f8;
  transition: all 0.3s ease;
  border-radius: 5px;
}

.month-tab-header li.active {
  background: #007bff;
  color: white;
  font-weight: bold;
  border-color: #007bff;
}

/* ğŸ“Œ æœˆã®ã‚¿ãƒ–å†…å®¹ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ */
.month-tab-pane {
  display: none;
  padding: 10px;
}

.month-tab-pane.active {
  display: block;
}

/* ğŸ“Œ æ‹…å½“è€…ã”ã¨ã®ã‚¿ãƒ– */
.tab-header {
  display: flex;
  list-style: none;
  padding: 0;
  border-bottom: 2px solid #ccc;
  justify-content: center;
  margin-bottom: 15px;
}

.tab-header li {
  padding: 8px 15px;
  cursor: pointer;
  border: 1px solid #ccc;
  margin-right: 5px;
  background: #f4f4f4;
  transition: all 0.3s ease;
  border-radius: 5px;
}

.tab-header li.active {
  background: #28a745;
  color: white;
  font-weight: bold;
  border-color: #28a745;
}

/* ğŸ“Œ æ‹…å½“è€…ã‚¿ãƒ–ã®å†…å®¹ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ */
.tab-pane {
  display: none;
  padding: 10px;
}

.tab-pane.active {
  display: block;
}

/* ğŸ“Œ æ—¥å ±ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.report-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
}



.report-table td {
  padding: 8px;
  text-align: center;
  border: 1px solid #ccc;
  background: #f9f9f9;
}

/* ğŸ“Œ è©³ç´°ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ */
.detail-link,
.edit-link {
  display: inline-block;
  padding: 5px 10px;
  text-decoration: none;
  color: white;
  background: #17a2b8;
  border-radius: 4px;
  transition: background 0.3s;
}

.detail-link:hover,
.edit-link:hover {
  background: #138496;
}
/* ğŸ“Œ æœˆé–“é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.summary-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: white;
  box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
}

.summary-table th {
  background: #343a40;
  color: white;
  padding: 10px;
  text-align: center;
  border: 1px solid #ccc;
}

.summary-table td {
  padding: 8px;
  text-align: center;
  border: 1px solid #ccc;
  background: #f9f9f9;
}

/* ğŸ“Œ æœˆã”ã¨ã®ã‚¿ãƒ– */
.month-tab-header {
  display: flex;
  list-style: none;
  padding: 0;
  border-bottom: 2px solid #ccc;
  margin-bottom: 10px;
  justify-content: center;
}

.month-tab-header li {
  padding: 10px 12px;
  cursor: pointer;
  border: 1px solid #ccc;
  margin: 0 5px;
  background: #f8f8f8;
  transition: all 0.3s ease;
  border-radius: 5px;
}

.month-tab-header li.active {
  background: #007bff;
  color: white;
  font-weight: bold;
  border-color: #007bff;
}

/* ğŸ“Œ æœˆã®ã‚¿ãƒ–å†…å®¹ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ */
.month-tab-pane {
  display: none;
  padding: 10px;
}

.month-tab-pane.active {
  display: block;
}

.new_per, .new_per th, .new_per td, .new_per tr, .new_per tbody, .new_per thead {
  font-size: 12px;
}
</style>
